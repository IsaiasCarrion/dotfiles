#!/bin/zsh

# ---| Carga Temprana de PATHs y Interactividad |--- #
# Solo cargar el script si es una sesión interactiva.
[[ $- != *i* ]] && return

# Define PATH para comandos de pipx.
export PATH="$HOME/.local/bin:$PATH"

# ---| Zinit Autoinstalación y Carga |--- #
ZINIT_HOME="${XDG_DATA_HOME:-$HOME/.local/share}/zinit"
if [[ ! -f "$ZINIT_HOME/zinit.zsh" ]]; then
  echo "Instalando Zinit..."
  mkdir -p "$ZINIT_HOME"
  git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME/bin"
fi
source "$ZINIT_HOME/bin/zinit.zsh"

# ---| Plugins via Zinit |--- #
zinit light zsh-users/zsh-syntax-highlighting
zinit light junegunn/fzf-zsh # Usa la versión de fzf-zsh para mejor integración
zinit light zsh-users/zsh-autosuggestions # Recomendado para productividad

# ---| Plugings Setup |--- #
# Corregido: Usar la ruta correcta para la instalación de fzf vía apt si existe
if [[ -f "/usr/share/fzf/key-bindings.zsh" ]]; then
    source "/usr/share/fzf/key-bindings.zsh"
elif [[ -f "/usr/share/doc/fzf/examples/key-bindings.zsh" ]]; then
    source "/usr/share/doc/fzf/examples/key-bindings.zsh"
fi

# ---| Starship Prompt |--- #
if command -v starship &> /dev/null; then
  eval "$(starship init zsh)"
fi

# ---| Paths de Caché y Configuración |--- #
XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"
HISTFILE="${XDG_CACHE_HOME}/zsh_history"
mkdir -p "$XDG_CACHE_HOME"

# ---| Shell Interno |--- #
KEYTIMEOUT=1
SAVEHIST=10000
HISTSIZE=10000
# Las siguientes opciones se pueden mover a setopt
setopt HIST_VERIFY
setopt SHARE_HISTORY
setopt HIST_IGNORE_SPACE
setopt HIST_SAVE_NO_DUPS
setopt HIST_IGNORE_ALL_DUPS

# ---| Inicialización de módulos y Compinit |--- #
autoload -U compinit promptinit terminfo zrecompile
if [[ -n "$compinit" ]]; then
  compinit -u -C
fi
promptinit
zmodload -i zsh/complist
zmodload -i zsh/comptags
zmodload -i zsh/compctl

# ---| Opciones del Shell |--- #
setopt AUTO_CD
setopt AUTO_CONTINUE
setopt CORRECT
setopt EXTENDED_GLOB
setopt GLOB_COMPLETE
setopt INTERACTIVE_COMMENTS
setopt LIST_PACKED
setopt LONG_LIST_JOBS
setopt NO_NOMATCH
setopt TRANSIENT_RPROMPT
# setopt COMPLETE_ES # Esta opción puede causar problemas de rendimiento y se puede omitir
setopt COMPLETE_IN_WORD # Reemplaza el comportamiento similar de COMPLETE_ES

# ---| History Navigation Mejorada |--- #
autoload -U up-line-or-beginning-search down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search

# ---| Fix para teclas especiales |--- #
if (( ${+terminfo[smkx]} && ${+terminfo[rmkx]} )); then
    function zle-line-init { echoti smkx }
    function zle-line-finish { echoti rmkx }
    zle -N zle-line-init
    zle -N zle-line-finish
fi

# ---| Funciones útiles |--- #
# Mejorado: Usa una función más robusta y no dependiente de awk/grep para un mejor rendimiento
toppy() {
    zle-line-init() { echoti smkx }
    zle-line-finish() { echoti rmkx }
    history -E 1 | awk '{print $2}' | sort | uniq -c | sort -nr | head -n 21
}

file_amount() {
    # Mejorado: wc -l cuenta la línea total, usar ls -A para evitar contar . y ..
    ls -A | wc -l
}

cd() {
    # Mejorado: usa un alias más simple, la función `cd` puede tener efectos secundarios
    builtin cd "$@" && eza -lF --git --icons
}

src() {
    # Mejorado: Usa el cache de compinit de forma correcta y simplificada
    autoload -Uz compinit
    compinit -u -C
    echo "Completado recargado."
}

reload-zsh() {
    # Mejorado: Usa exec para reemplazar el proceso actual
    exec zsh
}

# Las funciones npacs, npipx, npip, v, mkvenv y gpush son buenas y no requieren cambios mayores.

# ---| Aliases útiles |--- #
alias ..='cd ..'
alias gs='git status'
alias grep='grep --color=auto'
alias install='sudo nala install'
alias nup='sudo nala update && sudo nala upgrade -y' # Añadido sudo a nala upgrade
alias aup='sudo apt-get update && sudo apt-get upgrade -y' # Añadido sudo a apt-get upgrade
alias ls='eza -lF --git --icons'
alias ll='eza -alF --git --icons'
alias bat='batcat'

# ---| Estilos de Autocompletado |--- #
# Consolidado y simplificado para un mejor rendimiento
zstyle ':completion:*' completer _complete _match _approximate
zstyle ':completion:*' menu select=2
zstyle ':completion:*' list-colors ''
zstyle ':completion:*' file-sort name
zstyle ':completion:*' group-name
zstyle ':completion:*' list-prompt '%S%M matches%s'
zstyle ':completion:*' verbose yes
zstyle ':completion:*:match:*' original only
zstyle ':completion:*:approximate:*' max-errors 'reply=($(( ($#PREFIX + $#SUFFIX) / 3 )) numeric)'
zstyle ':completion:*:correct:*' original true
zstyle ':completion:*:correct:*' insert-unambiguous true
zstyle ':completion:*' rehash true
zstyle ':completion:*' cache-path "$XDG_CACHE_HOME/zcompcache"
zstyle ':completion:*' use-cache yes
zstyle ':completion:*' auto-description '%d'
